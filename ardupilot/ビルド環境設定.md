前の会話履歴での経験を踏まえ、福井大学のWSL2 Ubuntu環境でArduPilotの完全なビルド環境を構築するための統合スクリプトを作成しました。

# ArduPilot開発環境完全セットアップスクリプト

## **メインセットアップスクリプト**

```bash
#!/bin/bash
# ArduPilot開発環境完全セットアップスクリプト
# 対象: WSL2 Ubuntu 24.04 @ 福井大学
# 作成者: 前の会話履歴を基に統合

set -e  # エラー時に停止

echo "======================================"
echo "ArduPilot開発環境セットアップ開始"
echo "対象: WSL2 Ubuntu 24.04 @ 福井大学"
echo "======================================"

# 作業ディレクトリの設定
WORK_DIR="$HOME/UMEMOTO2"
VENV_NAME="venv_ardupilot"
ARDUPILOT_DIR="$WORK_DIR/ardupilot"

# 関数定義
setup_proxy() {
    echo "## プロキシ設定を追加中..."
    
    # ~/.bashrcにプロキシ関数を追加
    cat >> ~/.bashrc /dev/null
  git config --global https.proxy "$https_proxy" 2>/dev/null

  # pipのプロキシ設定
  mkdir -p ~/.config/pip
  cat > ~/.config/pip/pip.conf  /etc/apt/apt.conf.d/95proxies  ~/.wgetrc  ~/.curlrc  ~/.condarc /dev/null
  git config --global --unset https.proxy 2>/dev/null
  rm -f ~/.config/pip/pip.conf
  sudo rm -f /etc/apt/apt.conf.d/95proxies
  rm -f ~/.wgetrc ~/.curlrc ~/.condarc
  
  echo "🚫 プロキシを無効にしました"
}

function proxy_status() {
  if [ -n "$http_proxy" ]; then
    echo "✅ プロキシが有効: $http_proxy"
  else
    echo "🚫 プロキシが無効"
  fi
}

# ArduPilot開発用エイリアス
alias ardupilot='cd ~/UMEMOTO2/ardupilot && source ../venv_ardupilot/bin/activate'
alias sitl_copter='cd ~/UMEMOTO2/ardupilot/ArduCopter && sim_vehicle.py --console --map'
alias sitl_plane='cd ~/UMEMOTO2/ardupilot/ArduPlane && sim_vehicle.py --console --map'

EOF

    echo "✅ プロキシ設定関数を~/.bashrcに追加完了"
}

install_system_dependencies() {
    echo "## システム依存関係をインストール中..."
    
    # プロキシ設定を有効化
    source ~/.bashrc
    proxy_on
    
    # パッケージリストを更新
    sudo apt update
    
    # 基本的な開発ツール
    sudo apt install -y \
        git \
        build-essential \
        cmake \
        python3 \
        python3-pip \
        python3-dev \
        python3-virtualenv \
        python-is-python3
    
    # ArduPilot固有の依存関係
    sudo apt install -y \
        gcc-arm-none-eabi \
        libnewlib-arm-none-eabi \
        ccache \
        g++ \
        gawk \
        make \
        wget \
        rsync
    
    # 不要パッケージの削除
    sudo apt autoremove -y
    
    echo "✅ システム依存関係のインストール完了"
}

setup_virtual_environment() {
    echo "## Python仮想環境をセットアップ中..."
    
    # 作業ディレクトリの作成
    mkdir -p "$WORK_DIR"
    cd "$WORK_DIR"
    
    # 既存の仮想環境を削除
    if [ -d "$VENV_NAME" ]; then
        echo "既存の仮想環境を削除中..."
        rm -rf "$VENV_NAME"
    fi
    
    # Ubuntu 24.04対応: virtualenvを使用
    echo "virtualenvで仮想環境を作成中..."
    virtualenv "$VENV_NAME"
    
    # 仮想環境を有効化
    source "$VENV_NAME/bin/activate"
    
    # pip、setuptools、wheelを最新版に更新
    pip install --upgrade pip setuptools wheel
    
    # ArduPilotに必要なPythonパッケージをインストール
    echo "ArduPilot用Pythonパッケージをインストール中..."
    pip install empy==3.3.4
    pip install dronecan
    pip install pexpect
    pip install pymavlink
    pip install matplotlib
    pip install numpy
    pip install scipy
    
    echo "✅ Python仮想環境のセットアップ完了"
}

clone_ardupilot() {
    echo "## ArduPilotソースコードをクローン中..."
    
    cd "$WORK_DIR"
    
    # 既存のArduPilotディレクトリを削除
    if [ -d "ardupilot" ]; then
        echo "既存のArduPilotディレクトリを削除中..."
        rm -rf ardupilot
    fi
    
    # ArduPilotをクローン
    echo "GitHubからArduPilotをクローン中... (時間がかかります)"
    git clone https://github.com/ArduPilot/ardupilot.git
    cd ardupilot
    
    # サブモジュールを初期化
    echo "サブモジュールを初期化中... (さらに時間がかかります)"
    git submodule update --init --recursive
    
    echo "✅ ArduPilotソースコードのクローン完了"
}

run_ardupilot_setup() {
    echo "## ArduPilot公式セットアップスクリプトを実行中..."
    
    cd "$ARDUPILOT_DIR"
    
    # 仮想環境を一時的に無効化
    deactivate
    
    # ArduPilot公式のセットアップスクリプトを実行
    Tools/environment_install/install-prereqs-ubuntu.sh -y
    
    # プロファイルを再読み込み
    source ~/.profile
    
    # 仮想環境を再度有効化
    source "../$VENV_NAME/bin/activate"
    
    echo "✅ ArduPilot公式セットアップスクリプト実行完了"
}

configure_and_test_build() {
    echo "## ビルド設定とテストを実行中..."
    
    cd "$ARDUPILOT_DIR"
    source "../$VENV_NAME/bin/activate"
    
    # Pixhawk6C向けに設定
    echo "Pixhawk6C向けにビルド設定中..."
    ./waf configure --board Pixhawk6C
    
    # テストビルド実行
    echo "テストビルドを実行中..."
    ./waf copter
    
    echo "✅ ビルド設定とテスト完了"
}

create_usage_guide() {
    echo "## 使用方法ガイドを作成中..."
    
    cat > "$WORK_DIR/USAGE_GUIDE.md" << 'EOF'
# ArduPilot開発環境使用ガイド

## 毎回の開発開始手順

```
# 1. プロキシ有効化
proxy_on

# 2. 作業ディレクトリに移動
cd ~/UMEMOTO2

# 3. 仮想環境有効化
source venv_ardupilot/bin/activate

# 4. ArduPilotディレクトリに移動
cd ardupilot
```

## 便利なエイリアス

```
# ArduPilot環境への移動と仮想環境有効化
ardupilot

# SITLシミュレーター起動
sitl_copter  # マルチコプター
sitl_plane   # 固定翼機
```

## よく使うコマンド

```
# ビルド設定
./waf configure --board Pixhawk6C

# ビルド実行
./waf copter    # マルチコプター
./waf plane     # 固定翼機
./waf rover     # 地上車両

# クリーンビルド
./waf clean
./waf configure --board Pixhawk6C
./waf copter

# SITLシミュレーター
cd ArduCopter
sim_vehicle.py --console --map
```

## プロキシ管理

```
proxy_on      # プロキシ有効化
proxy_off     # プロキシ無効化
proxy_status  # プロキシ状態確認
```

## トラブルシューティング

### ビルドエラーの場合
```
./waf clean
git submodule update --init --recursive
./waf configure --board Pixhawk6C
./waf copter
```

### プロキシエラーの場合
```
proxy_off
proxy_on
proxy_status
```
EOF

    echo "✅ 使用方法ガイド作成完了: $WORK_DIR/USAGE_GUIDE.md"
}

# メイン実行
main() {
    echo "セットアップを開始します..."
    
    setup_proxy
    source ~/.bashrc  # プロキシ関数を読み込み
    
    install_system_dependencies
    setup_virtual_environment
    clone_ardupilot
    run_ardupilot_setup
    configure_and_test_build
    create_usage_guide
    
    echo ""
    echo "======================================"
    echo "🎉 ArduPilot開発環境セットアップ完了!"
    echo "======================================"
    echo ""
    echo "次回からの使用方法:"
    echo "1. proxy_on"
    echo "2. cd ~/UMEMOTO2"
    echo "3. source venv_ardupilot/bin/activate"
    echo "4. cd ardupilot"
    echo ""
    echo "または簡単に: ardupilot"
    echo ""
    echo "詳細は $WORK_DIR/USAGE_GUIDE.md を参照してください"
}

# スクリプト実行
main "$@"
```

## **スクリプトの実行方法**

### **1. スクリプトファイルの作成**

```bash
# ホームディレクトリにスクリプトを作成
cd ~
nano setup_ardupilot.sh
```

上記のスクリプト内容をファイルに貼り付けて保存してください。

### **2. スクリプトを実行可能にする**

```bash
chmod +x setup_ardupilot.sh
```

### **3. スクリプトの実行**

```bash
./setup_ardupilot.sh
```

## **スクリプトの主な特徴**

### **✅ 前の会話で解決した問題への対応**
- **Ubuntu 24.04のPEP 668制限**: `virtualenv`を使用
- **福井大学プロキシ環境**: 包括的なプロキシ設定関数
- **依存関係の競合**: 特定バージョン指定（`empy==3.3.4`）
- **ARM環境**: `gcc-arm-none-eabi`の自動インストール

### **✅ 統合された機能**
- **システム依存関係**: APTパッケージの一括インストール
- **Python仮想環境**: 確実な環境分離
- **ArduPilotクローン**: サブモジュール含む完全取得
- **公式セットアップ**: `install-prereqs-ubuntu.sh`の実行
- **ビルドテスト**: Pixhawk6C向けの動作確認

### **✅ 使いやすさの向上**
- **エイリアス設定**: `ardupilot`、`sitl_copter`など
- **使用方法ガイド**: `USAGE_GUIDE.md`の自動生成
- **エラーハンドリング**: `set -e`で停止処理

このスクリプトにより、前の会話で蓄積されたすべての知見が統合され、福井大学のWSL2環境でArduPilotの完全な開発環境を一度に構築できます。

[1] https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark@2x.png

# カルマンフィルタの基礎知識

## カルマンフィルタとは

<div style="border:2px solid #1976d2; border-radius:8px; padding:14px; background:#e3f2fd;">
<span style="font-size:1.1em; color:#1565c0; font-weight:bold;">カルマンフィルタとは？</span><br>
<span style="font-size:1em;">カルマンフィルタは、<b style="color:#d32f2f;">複数の誤差を含む観測値</b>を統合して、<b style="color:#388e3c;">対象の状態を推定</b>する手法である。</span>
</div>

---

## 例：ドローンのロール角度推定

### 使用するセンサの特徴

<div style="border:2px solid #388e3c; border-radius:8px; padding:12px; background:#f1f8e9;">
<span style="font-size:1.05em; color:#388e3c; font-weight:bold;">🟢 ジャイロセンサ（角速度計）</span><br>
<ul>
  <li><b>原理：</b>ジャイロセンサで取得できる角速度 $\omega$ を積分することでロール角 $\phi$ を求める。<br>
    <span style="color:#1976d2;">図では $f(x) = \omega$ がジャイロセンサの角速度を示し、積分した面積 $F(x)$ がロール角 $\phi$ に相当する。</span>
  </li>
  <li><img src="../picture/integral.png" alt="integral" width="60%" /></li>
  <li><b style="color:#388e3c;">メリット：</b>応答が速い</li>
  <li><b style="color:#d32f2f;">デメリット：</b>時間とともにドリフト誤差が蓄積する</li>
</ul>
</div>

<div style="border:2px solid #1976d2; border-radius:8px; padding:12px; background:#e3f2fd; margin-top:8px;">
<span style="font-size:1.05em; color:#1976d2; font-weight:bold;">🔵 加速度計</span><br>
<ul>
  <li><b>原理：</b>重力加速度から静的なロール角を算出する</li>
  <li><b style="color:#388e3c;">メリット：</b>ドリフトがなく、長期間での安定性が高い</li>
  <li><b style="color:#d32f2f;">デメリット：</b>ドローンが動くと加速度の影響でノイズが大きくなる</li>
</ul>
</div>

---

## カルマンフィルタの動作原理

### **ステップ1：予測（ジャイロセンサによる角度推定）**

ジャイロの角速度を積分してロール角を予測する。

$$ \phi_b = \phi_a + \sum_{i=a}^{b-1} \omega_{i} \Delta t $$

**パラメータの説明**：
- $\phi_b$：区間 $a$ から $b$ まで積分（総和）したロール角
- $\phi_a$：区間 $a$ 時点のロール角（初期値）
- $\omega_{i}$：区間 $i$（$i=a$ から $b-1$）でジャイロで測定した角速度
- $\Delta t$：サンプリング時間（各区間の幅）

### **ステップ2：観測（加速度計によるロール角測定）**

加速度計で重力方向を測定し、機体のロール角 $\phi_{acc}$ を計算する。  
※詳細な導出は省略する。

### **ステップ3：統合（予測値と観測値の融合）**

**イノベーション（予測値と観測値の差）を計算する**：

$$ y_k = \phi_{acc} - \phi_b $$

**2つのデータを用いて推定値を計算する**：

$$ \phi_{k|k} = \phi_b + K_k \cdot y_k $$

ここで、**カルマンゲイン $K_k$** は予測値をどれだけ補正するかを決めるパラメータである。

- $K_k$ が大きいほど観測値（加速度計）を重視する
- $K_k$ が小さいほど予測値（ジャイロ）を重視する

---

## カルマンゲインの調整

カルマンゲインは、基本的にはセンサのノイズの共分散行列をもとに調整されるが、実際にはシステムの特性や動作環境に応じて微調整することが多い。  
カルマンゲイン $K_k$ が推定精度において重要な役割を果たす。

### **調整の仕組み**


<div style="border:2px solid #4A90E2; border-radius:8px; padding:16px; background:#f7faff;">

<span style="font-size:1.1em; color:#1565c0; font-weight:bold;">カルマンゲイン調整のポイント</span>

<ul>
  <li><b style="color:#388e3c;">加速度計のウェイト（重み）を大きくする</b>と、<span style="color:#1976d2;">短期的な応答性が向上</span>する。<br>
    しかし、加速度計のノイズや外乱の影響を受けやすくなり、<span style="color:#d32f2f;">長期的なドリフトが大きくなる可能性</span>がある。
  </li>
  <li><b style="color:#388e3c;">加速度計のウェイトを小さくし、ジャイロセンサの予測値を重視する</b>と、<span style="color:#1976d2;">短期的なノイズには強くなる</span>が、<span style="color:#d32f2f;">ジャイロ特有のドリフトが蓄積しやすくなる</span>。
  </li>
</ul>

<span style="font-weight:bold; color:#1565c0;">バランス調整が重要</span>：<br>
このバランスを適切に調整することで、ジャイロの長期ドリフトと加速度計の短期ノイズを相互に補正し、両方の利点を活かした推定が可能になる。

</div>

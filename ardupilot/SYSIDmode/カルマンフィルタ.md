# カルマンフィルタの概要

<div style="text-align: right;">
福井大学　大学院工学研究科博士前期課程 <br> 安全社会基盤工学専攻 機械設計工学コース
<br>瀧敬太
</div>

> **カルマンフィルタとは**
>
> <span style="color:#1976d2; font-weight:bold;">複数の誤差を含む観測値を統合して、対象の状態を推定する手法</span>である。


## ArduPilot が統合する主なセンサ

主なセンサ：

- IMU（ジャイロ + 加速度計）
- 磁力計（コンパス）
- 気圧計（バロメータ）
- GPS / GNSS
- 光学フロー / ビジョンセンサ
- レンジファインダ（超音波・LiDAR）
- モーションキャプチャ（MOCAP / VICON）
- 対気速度計（Pitot）
- その他の追加センサも統合可能な場合がある

---

## 例：ドローンの姿勢角推定
#### 角速度を求めるジャイロセンサと角度を求める加速度計の統合

ここではドローンの姿勢角を推定する例を示す。本来機体の姿勢角を角度の次元で取得できるセンサは加速度計のみである。しかし、カルマンフィルタでは、角速度を取得できるジャイロセンサのデータを時間積分することで、角度の次元に変換し、加速度計のデータと統合することができる。

---

#### <span style="color:#388e3c; font-weight:bold;">1. ジャイロセンサ（角速度計）</span>

> 角度を直接求めることはできないセンサ。

<img src="../picture/integral.png" alt="integral" width="60%" />

> **図出典**：『積分とは — 数学ノート（統計学で使う数学）』, ベルカーブ研究所（bellcurve.jp）  
> 出典URL: https://bellcurve.jp/statistics/course/10188.html


- <span style="color:#1976d2; font-weight:bold;">原理</span>：ジャイロセンサで取得できる角速度 $\omega$ を時間積分することでロール角 $\phi$ を求める。
    - 図では $f(x) = \omega$ がジャイロセンサの角速度を示す。
    - 積分した面積 $F(x)$ がロール角 $\phi$ に相当する。

- <span style="color:#43a047; font-weight:bold;">メリット</span>：応答が速い。
- <span style="color:#d32f2f; font-weight:bold;">デメリット</span>：時間とともにドリフト誤差が蓄積する。


#### <span style="color:#388e3c; font-weight:bold;">2. 加速度計</span>

> 角度を直接求めることができるセンサ。

- <span style="color:#1976d2; font-weight:bold;">原理</span>：重力加速度から静的なロール角を算出する。
- <span style="color:#43a047; font-weight:bold;">メリット</span>：ドリフトがなく、長期間での安定性が高い。
- <span style="color:#d32f2f; font-weight:bold;">デメリット</span>：ドローンが動くと加速度の影響でノイズが大きくなったり、細かな動きがノイズに埋もれたりする。

---

# カルマンフィルタの動作原理

### **ステップ1：予測（ジャイロセンサによる角度推定）**

ジャイロの角速度を積分してロール角を予測する。

$$ \phi_b = \phi_a + \sum_{i=a}^{b-1} \omega_{i} \Delta t $$

**パラメータの説明**：
- $\phi_b$：区間 $a$ から $b$ まで積分（総和）したロール角
- $\phi_a$：区間 $a$ 時点のロール角（初期値）
- $\omega_{i}$：区間 $i$（$i=a$ から $b-1$）でジャイロで測定した角速度
- $\Delta t$：サンプリング時間（各区間の幅）

### **ステップ2：観測（加速度計によるロール角測定）**

加速度計で重力方向を測定し、機体のロール角 $\phi_{acc}$ を計算する。  
※詳細な導出は省略する。

### **ステップ3：統合（予測値と観測値の融合）**

**イノベーション（予測値と観測値の差）を計算する**：

$$ y_k = \phi_{acc} - \phi_b $$

**2つのデータを用いて推定値を計算する**：

$$ \phi_{k|k} = \phi_b + K_k \cdot y_k $$

ここで、**カルマンゲイン $K_k$** は予測値をどれだけ補正するかを決めるパラメータである。

- $K_k$ が大きいほど観測値（加速度計）を重視する
- $K_k$ が小さいほど予測値（ジャイロ）を重視する


## カルマンゲイン

カルマンゲインは、基本的にはセンサノイズの共分散行列をもとに調整される。センサノイズが大きいものは信頼度を低くし、ノイズが小さいものは信頼度を高くする。
実際にardupilotでは、このノイズを設定するパラメータが用意されており、EK3_ACC_P_NSE などのパラメータで設定する。ノイズの大きさをパラメータとして設定することで、カルマンゲインの値が変化し、推定の特性が変わる。

### **調整の仕組み**


<div style="border:2px solid #4A90E2; border-radius:8px; padding:16px; background:#f7faff;">

<span style="font-size:1.1em; color:#1565c0; font-weight:bold;">カルマンゲイン調整のポイント</span>

<ul>
  <li><b style="color:#388e3c;">加速度計のノイズ設定を大きくする</b>と、<span style="color:#1976d2;">加速度計の値の信頼度が下がり、ジャイロセンサの予測値が重視される</span>。<br>
    その結果、<span style="color:#d32f2f;">短期的なノイズには強くなるが、ジャイロ特有のドリフトが蓄積しやすくなる</span>。
  </li>
  <li><b style="color:#388e3c;">加速度計のノイズ設定を小さくする</b>と、<span style="color:#1976d2;">加速度計の値の信頼度が上がり、観測値（加速度計）が重視される</span>。<br>
    その結果、<span style="color:#d32f2f;">短期的な応答性は向上するが、加速度計のノイズや外乱の影響を受けやすくなり、長期的なドリフトが大きくなる可能性がある</span>。
  </li>
</ul>

</div>


#### まとめ
カルマンフィルタは、複数のセンサから得られる情報をノイズの大きさを考慮しながら統合し、システムの状態（例：姿勢角、位置、速度など）を推定する手法である。加速度と速度、加速度とGPSの位置情報など、異なる種類のデータを同時に扱える点が大きなメリットである。姿勢角だけでなく、位置やその他の状態についても同様に推定が可能である。



---

## 参考文献

- ベルカーブ研究所『積分とは — 数学ノート（統計学で使う数学）』, https://bellcurve.jp/statistics/course/10188.html
- ArduPilot Extended Kalman Filter: https://ardupilot.org/dev/docs/extended-kalman-filter.html
- MathWorks カルマンフィルタ解説: https://jp.mathworks.com/discovery/kalman-filter.html


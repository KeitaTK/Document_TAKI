# ゼミ

## 1. 進捗

### ArduPilotとのMAVLink通信と自作プログラムの定期実行

- **目的**: ArduPilotと外部コンピュータ（Raspberry Pi）間でのMAVLinkメッセージの送受信と、RTOSへの組み込み。
- **実現内容1**: カスタムメセージの送受信
  - Raspberry PiからArduPilotに対してリクエスト（MAVLinkメッセージ）を送信。
  - ArduPilot側がそのリクエストに応じて、指定されたメッセージを返信。
- **実現内容2**: 自作プログラムを定期実行に加える
  - C++でのプログラム作成（めっちゃ簡単なやつ）。
  - ArduPilotのRTOSに優先度と実行周期を設定し定期実行。
- **使用環境**:
  - Flight Controller: Pixhawk 6C
  - 外部通信: USB経由
  - 使用プロトコル: MAVLink（ardupilotmega.xml）

---

## 2. 姿勢制御の基本構造

ArduPilotの姿勢制御は主に2つの制御層で構成されています[^4]：

1. **姿勢コントローラー（Attitude Controller）**：目標姿勢と現在姿勢の差から必要な角速度を計算
2. **レートコントローラー（Rate Controller）**：目標角速度を達成するためのモーター出力を計算

これらのコントローラーは「AC_AttitudeControl」というライブラリに実装されており、マルチコプター向けには「AC_AttitudeControl_Multi」クラスが使用されています[^2]。

### 制御の流れ

制御の流れは以下のようになります：

1. **パイロット入力/オートパイロット** → **目標姿勢/角速度の生成**
    - 安定化モードでは目標姿勢角に変換
    - アクロモードでは直接角速度に変換
2. **姿勢コントローラー**：
    - 目標姿勢と現在姿勢の差（姿勢誤差）を計算
    - P制御を使用して必要な角速度を生成（Square root controller）[^1]
    - `attitude_controller_run_quat`関数で実行[^5]
3. **レートコントローラー**：
    - 目標角速度と実測角速度の差に基づいてPID制御を実行
    - フィードフォワード経路も使用（ATC_RATE_FF_ENABパラメーターで有効化）[^4][^5]
    - PID出力とフィードフォワード出力を合計
4. **モーターミキシング（AP_Motors）**：
    - コントローラー出力（-1から+1の範囲）をモーター出力に変換[^2]
    - `set_roll`、`set_pitch`、`set_yaw`関数を通じて制御値を受け取る[^5]

### 各軸の制御（Roll, Pitch, Yaw）

各軸（ロール、ピッチ、ヨー）はそれぞれ独立したコントローラーで制御されています[^2]：

- **ロール/ピッチ制御**：
    - 姿勢角誤差からP制御で角速度要求を生成
    - 角速度誤差にPID制御を適用
    - `ATC_ANG_xxx`パラメーターで姿勢制御の応答性を調整
    - `ATC_RAT_xxx_P/I/D`パラメーターでレート制御を調整[^4]
- **ヨー制御**：
    - 同様の階層構造だが、ヨーレートの制御が主


---

## 3. ArduPilotのEKF（拡張カルマンフィルター）

ArduPilotは拡張カルマンフィルター（Extended Kalman Filter: EKF）アルゴリズムを使用して、ジャイロスコープや加速度計などのセンサーデータから機体の位置、速度、角度姿勢を推定しています[^1]。現在の安定版ArduPilotでは、EKF3が主要な姿勢・位置推定ソースとして使用され、DCM（Direction Cosine Matrix）はバックグラウンドで動作しています。

### MAVLinkを使ったEKF3への入力フロー

ARマーカー検出からEKF3への入力の流れは次のようになります：

1. **姿勢・位置データの取得**:
    - ラズパイのカメラでArUcoマーカーを検出
    - OpenCVを使用して姿勢（rvecs）と位置（tvecs）を推定[^6]
    - カメラフレームからボディフレームへの変換[^3]
2. **MAVLinkメッセージへの変換**:
    - 推定データをMAVLinkのVISION_POSITION_ESTIMATEなどのメッセージ形式に変換
    - メッセージにはタイムスタンプ、位置、姿勢情報を含める
3. **ArduPilotへの送信**:
    - シリアル接続またはネットワーク経由でMAVLinkメッセージを送信
    - 一般的な接続速度は921600bpsなど
4. **EKF3の設定**:
    - `AHRS_EKF_TYPE = 3` でEKF3を有効化[^5]
    - 外部センサーとして設定: `EK3_SRC1_POSXY = 3`（GPSから水平位置）などのパラメーターを設定[^5]
    - ビジョン位置推定を使用する場合は適切なソースパラメーターを設定
5. **センサーデータの統合**:
    - EKF3はARマーカーから得た位置・姿勢データを他のセンサー（IMU、気圧計など）と統合
    - センサー親和性機能により、最も信頼性の高いデータソースを選択[^1]
6. **フィードバック制御への利用**:
    - 推定された位置・姿勢データは制御システムにフィードバックされ、機体の安定化や自律飛行に使用
